<!doctype html><html><head><meta name='viewport' content='width=device-width,initial-scale=1'><meta charset='UTF-8'><link rel='stylesheet' type='text/css' href='../../../../../../style.css'></head><body><h2>Coverage Report</h2><h4>Created: 2024-01-04 13:31</h4><div class='centered'><table><div class='source-name-title'><pre>/home/cdecker/dev/lightning/bitcoin/feerate.h</pre></div><tr><td><pre>Line</pre></td><td><pre>Count</pre></td><td><pre>Source</pre></td></td></tr><tr><td class='line-number'><a name='L1' href='#L1'><pre>1</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>#ifndef LIGHTNING_BITCOIN_FEERATE_H</pre></td></tr><tr><td class='line-number'><a name='L2' href='#L2'><pre>2</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>#define LIGHTNING_BITCOIN_FEERATE_H</pre></td></tr><tr><td class='line-number'><a name='L3' href='#L3'><pre>3</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>#include &quot;config.h&quot;</pre></td></tr><tr><td class='line-number'><a name='L4' href='#L4'><pre>4</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>#include &lt;ccan/build_assert/build_assert.h&gt;</pre></td></tr><tr><td class='line-number'><a name='L5' href='#L5'><pre>5</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>#include &lt;ccan/short_types/short_types.h&gt;</pre></td></tr><tr><td class='line-number'><a name='L6' href='#L6'><pre>6</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>#include &lt;common/amount.h&gt;</pre></td></tr><tr><td class='line-number'><a name='L7' href='#L7'><pre>7</pre></a></td><td class='uncovered-line'></td><td class='code'><pre></pre></td></tr><tr><td class='line-number'><a name='L8' href='#L8'><pre>8</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>/* bitcoind considers 250 satoshi per kw to be the minimum acceptable fee:</pre></td></tr><tr><td class='line-number'><a name='L9' href='#L9'><pre>9</pre></a></td><td class='uncovered-line'></td><td class='code'><pre> * less than this won&apos;t even relay.</pre></td></tr><tr><td class='line-number'><a name='L10' href='#L10'><pre>10</pre></a></td><td class='uncovered-line'></td><td class='code'><pre> */</pre></td></tr><tr><td class='line-number'><a name='L11' href='#L11'><pre>11</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>#define BITCOIND_MINRELAYTXFEE_PER_KW 250</pre></td></tr><tr><td class='line-number'><a name='L12' href='#L12'><pre>12</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>/*</pre></td></tr><tr><td class='line-number'><a name='L13' href='#L13'><pre>13</pre></a></td><td class='uncovered-line'></td><td class='code'><pre> * But bitcoind uses vbytes (ie. (weight + 3) / 4) for this</pre></td></tr><tr><td class='line-number'><a name='L14' href='#L14'><pre>14</pre></a></td><td class='uncovered-line'></td><td class='code'><pre> * calculation, rather than weight, meaning we can disagree since we do</pre></td></tr><tr><td class='line-number'><a name='L15' href='#L15'><pre>15</pre></a></td><td class='uncovered-line'></td><td class='code'><pre> * it sanely (as specified in BOLT #3).</pre></td></tr><tr><td class='line-number'><a name='L16' href='#L16'><pre>16</pre></a></td><td class='uncovered-line'></td><td class='code'><pre> */</pre></td></tr><tr><td class='line-number'><a name='L17' href='#L17'><pre>17</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>#define FEERATE_BITCOIND_SEES(feerate, weight) \</pre></td></tr><tr><td class='line-number'><a name='L18' href='#L18'><pre>18</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>  (((feerate) * (weight)) / 1000 * 1000 / ((weight) + 3))</pre></td></tr><tr><td class='line-number'><a name='L19' href='#L19'><pre>19</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>/* ie. fee = (feerate * weight) // 1000</pre></td></tr><tr><td class='line-number'><a name='L20' href='#L20'><pre>20</pre></a></td><td class='uncovered-line'></td><td class='code'><pre> * bitcoind needs (worst-case): fee * 1000 / (weight + 3) &gt;= 250</pre></td></tr><tr><td class='line-number'><a name='L21' href='#L21'><pre>21</pre></a></td><td class='uncovered-line'></td><td class='code'><pre> *</pre></td></tr><tr><td class='line-number'><a name='L22' href='#L22'><pre>22</pre></a></td><td class='uncovered-line'></td><td class='code'><pre> * (feerate * weight) // 1000 * 1000 // (weight + 3) &gt;= 250</pre></td></tr><tr><td class='line-number'><a name='L23' href='#L23'><pre>23</pre></a></td><td class='uncovered-line'></td><td class='code'><pre> *</pre></td></tr><tr><td class='line-number'><a name='L24' href='#L24'><pre>24</pre></a></td><td class='uncovered-line'></td><td class='code'><pre> * The feerate needs to be higher for lower weight, and our minimum tx weight</pre></td></tr><tr><td class='line-number'><a name='L25' href='#L25'><pre>25</pre></a></td><td class='uncovered-line'></td><td class='code'><pre> * is 464 (version (4) + count_tx_in (1) + tx_in (32 + 4 + 1 + 4) +</pre></td></tr><tr><td class='line-number'><a name='L26' href='#L26'><pre>26</pre></a></td><td class='uncovered-line'></td><td class='code'><pre> * count_tx_out (1) + amount (8) + P2WSH (1 + 1 + 32) + witness 1 + 1 + &lt;sig&gt;</pre></td></tr><tr><td class='line-number'><a name='L27' href='#L27'><pre>27</pre></a></td><td class='uncovered-line'></td><td class='code'><pre> * + 1 + &lt;key&gt;).  Assume it&apos;s 400 to give a significant safety margin (it</pre></td></tr><tr><td class='line-number'><a name='L28' href='#L28'><pre>28</pre></a></td><td class='uncovered-line'></td><td class='code'><pre> * only makes 1 difference in the result anyway).</pre></td></tr><tr><td class='line-number'><a name='L29' href='#L29'><pre>29</pre></a></td><td class='uncovered-line'></td><td class='code'><pre> */</pre></td></tr><tr><td class='line-number'><a name='L30' href='#L30'><pre>30</pre></a></td><td class='covered-line'><pre>9</pre></td><td class='code'><pre>#define MINIMUM_TX_WEIGHT 400</pre></td></tr><tr><td class='line-number'><a name='L31' href='#L31'><pre>31</pre></a></td><td class='uncovered-line'></td><td class='code'><pre></pre></td></tr><tr><td class='line-number'><a name='L32' href='#L32'><pre>32</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>/*</pre></td></tr><tr><td class='line-number'><a name='L33' href='#L33'><pre>33</pre></a></td><td class='uncovered-line'></td><td class='code'><pre> * This formula is satisfied by a feerate of 253 (hand-search).</pre></td></tr><tr><td class='line-number'><a name='L34' href='#L34'><pre>34</pre></a></td><td class='uncovered-line'></td><td class='code'><pre> */</pre></td></tr><tr><td class='line-number'><a name='L35' href='#L35'><pre>35</pre></a></td><td class='covered-line'><pre>770k</pre></td><td class='code'><pre>#define FEERATE_FLOOR 253</pre></td></tr><tr><td class='line-number'><a name='L36' href='#L36'><pre>36</pre></a></td><td class='uncovered-line'></td><td class='code'><pre></pre></td></tr><tr><td class='line-number'><a name='L37' href='#L37'><pre>37</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>enum feerate_style {</pre></td></tr><tr><td class='line-number'><a name='L38' href='#L38'><pre>38</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>  FEERATE_PER_KSIPA,</pre></td></tr><tr><td class='line-number'><a name='L39' href='#L39'><pre>39</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>  FEERATE_PER_KBYTE</pre></td></tr><tr><td class='line-number'><a name='L40' href='#L40'><pre>40</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>};</pre></td></tr><tr><td class='line-number'><a name='L41' href='#L41'><pre>41</pre></a></td><td class='uncovered-line'></td><td class='code'><pre></pre></td></tr><tr><td class='line-number'><a name='L42' href='#L42'><pre>42</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>static inline u32 feerate_floor_check(void)</pre></td></tr><tr><td class='line-number'><a name='L43' href='#L43'><pre>43</pre></a></td><td class='covered-line'><pre>547k</pre></td><td class='code'><pre>{</pre></td></tr><tr><td class='line-number'><a name='L44' href='#L44'><pre>44</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>  /* Assert that bitcoind will see this as above minRelayTxFee */</pre></td></tr><tr><td class='line-number'><a name='L45' href='#L45'><pre>45</pre></a></td><td class='covered-line'><pre>547k</pre></td><td class='code'><pre>  BUILD_ASSERT(FEERATE_BITCOIND_SEES(FEERATE_FLOOR, MINIMUM_TX_WEIGHT)</pre></td></tr><tr><td class='line-number'><a name='L46' href='#L46'><pre>46</pre></a></td><td class='covered-line'><pre>547k</pre></td><td class='code'><pre>         &gt;= BITCOIND_MINRELAYTXFEE_PER_KW);</pre></td></tr><tr><td class='line-number'><a name='L47' href='#L47'><pre>47</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>  /* And a lesser value won&apos;t do */</pre></td></tr><tr><td class='line-number'><a name='L48' href='#L48'><pre>48</pre></a></td><td class='covered-line'><pre>547k</pre></td><td class='code'><pre>  BUILD_ASSERT(FEERATE_BITCOIND_SEES(FEERATE_FLOOR-1, MINIMUM_TX_WEIGHT)</pre></td></tr><tr><td class='line-number'><a name='L49' href='#L49'><pre>49</pre></a></td><td class='covered-line'><pre>547k</pre></td><td class='code'><pre>         &lt; BITCOIND_MINRELAYTXFEE_PER_KW);</pre></td></tr><tr><td class='line-number'><a name='L50' href='#L50'><pre>50</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>  /* And I&apos;m right about it being OK for larger txs, too */</pre></td></tr><tr><td class='line-number'><a name='L51' href='#L51'><pre>51</pre></a></td><td class='covered-line'><pre>547k</pre></td><td class='code'><pre>  BUILD_ASSERT(FEERATE_BITCOIND_SEES(FEERATE_FLOOR, (MINIMUM_TX_WEIGHT*2))</pre></td></tr><tr><td class='line-number'><a name='L52' href='#L52'><pre>52</pre></a></td><td class='covered-line'><pre>547k</pre></td><td class='code'><pre>         &gt;= BITCOIND_MINRELAYTXFEE_PER_KW);</pre></td></tr><tr><td class='line-number'><a name='L53' href='#L53'><pre>53</pre></a></td><td class='uncovered-line'></td><td class='code'><pre></pre></td></tr><tr><td class='line-number'><a name='L54' href='#L54'><pre>54</pre></a></td><td class='covered-line'><pre>547k</pre></td><td class='code'><pre>  return FEERATE_FLOOR;</pre></td></tr><tr><td class='line-number'><a name='L55' href='#L55'><pre>55</pre></a></td><td class='covered-line'><pre>547k</pre></td><td class='code'><pre>}</pre><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: anchorspend.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: bitcoind.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: chaintopology.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: channel.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: channel_control.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: closing_control.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: coin_mvts.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: dual_open_control.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: connect_control.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='centered'><table><div class='source-name-title'><pre>feerate.c:feerate_floor_check</pre></div><tr><td><pre>Line</pre></td><td><pre>Count</pre></td><td><pre>Source</pre></td></tr><tr><td class='line-number'><a name='L43' href='#L43'><pre>43</pre></a></td><td class='covered-line'><pre>547k</pre></td><td class='code'><pre>{</pre></td></tr><tr><td class='line-number'><a name='L44' href='#L44'><pre>44</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>  /* Assert that bitcoind will see this as above minRelayTxFee */</pre></td></tr><tr><td class='line-number'><a name='L45' href='#L45'><pre>45</pre></a></td><td class='covered-line'><pre>547k</pre></td><td class='code'><pre>  BUILD_ASSERT(FEERATE_BITCOIND_SEES(FEERATE_FLOOR, MINIMUM_TX_WEIGHT)</pre></td></tr><tr><td class='line-number'><a name='L46' href='#L46'><pre>46</pre></a></td><td class='covered-line'><pre>547k</pre></td><td class='code'><pre>         &gt;= BITCOIND_MINRELAYTXFEE_PER_KW);</pre></td></tr><tr><td class='line-number'><a name='L47' href='#L47'><pre>47</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>  /* And a lesser value won&apos;t do */</pre></td></tr><tr><td class='line-number'><a name='L48' href='#L48'><pre>48</pre></a></td><td class='covered-line'><pre>547k</pre></td><td class='code'><pre>  BUILD_ASSERT(FEERATE_BITCOIND_SEES(FEERATE_FLOOR-1, MINIMUM_TX_WEIGHT)</pre></td></tr><tr><td class='line-number'><a name='L49' href='#L49'><pre>49</pre></a></td><td class='covered-line'><pre>547k</pre></td><td class='code'><pre>         &lt; BITCOIND_MINRELAYTXFEE_PER_KW);</pre></td></tr><tr><td class='line-number'><a name='L50' href='#L50'><pre>50</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>  /* And I&apos;m right about it being OK for larger txs, too */</pre></td></tr><tr><td class='line-number'><a name='L51' href='#L51'><pre>51</pre></a></td><td class='covered-line'><pre>547k</pre></td><td class='code'><pre>  BUILD_ASSERT(FEERATE_BITCOIND_SEES(FEERATE_FLOOR, (MINIMUM_TX_WEIGHT*2))</pre></td></tr><tr><td class='line-number'><a name='L52' href='#L52'><pre>52</pre></a></td><td class='covered-line'><pre>547k</pre></td><td class='code'><pre>         &gt;= BITCOIND_MINRELAYTXFEE_PER_KW);</pre></td></tr><tr><td class='line-number'><a name='L53' href='#L53'><pre>53</pre></a></td><td class='uncovered-line'></td><td class='code'><pre></pre></td></tr><tr><td class='line-number'><a name='L54' href='#L54'><pre>54</pre></a></td><td class='covered-line'><pre>547k</pre></td><td class='code'><pre>  return FEERATE_FLOOR;</pre></td></tr><tr><td class='line-number'><a name='L55' href='#L55'><pre>55</pre></a></td><td class='covered-line'><pre>547k</pre></td><td class='code'><pre>}</pre></td></tr></table></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: gossip_control.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: invoice.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: lightningd.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: log.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: memdump.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: notification.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: onchain_control.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: opening_common.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: opening_control.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: options.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: pay.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: peer_control.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: peer_htlcs.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: plugin.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: plugin_control.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: watch.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: wallet.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: walletrpc.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: reservation.c:feerate_floor_check</pre></div></div><div class='expansion-view'><div class='source-name-title'><pre>Unexecuted instantiation: json_param.c:feerate_floor_check</pre></div></div></td></tr><tr><td class='line-number'><a name='L56' href='#L56'><pre>56</pre></a></td><td class='uncovered-line'></td><td class='code'><pre></pre></td></tr><tr><td class='line-number'><a name='L57' href='#L57'><pre>57</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>u32 feerate_from_style(u32 feerate, enum feerate_style style);</pre></td></tr><tr><td class='line-number'><a name='L58' href='#L58'><pre>58</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>u32 feerate_to_style(u32 feerate_perkw, enum feerate_style style);</pre></td></tr><tr><td class='line-number'><a name='L59' href='#L59'><pre>59</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>const char *feerate_style_name(enum feerate_style style);</pre></td></tr><tr><td class='line-number'><a name='L60' href='#L60'><pre>60</pre></a></td><td class='uncovered-line'></td><td class='code'><pre></pre></td></tr><tr><td class='line-number'><a name='L61' href='#L61'><pre>61</pre></a></td><td class='uncovered-line'></td><td class='code'><pre>#endif /* LIGHTNING_BITCOIN_FEERATE_H */</pre></td></tr></table></div></body></html>